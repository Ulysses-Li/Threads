<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tapered Thread</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" />
  <style>
    textarea {
      height: 400px;
    }

    .site-footer {
      background: #3f474b;
      color: #e9ecef
    }

    .site-footer .footer-topbar {
      height: 10px;
      background: #c7c7c7
    }

    .site-footer a {
      color: #e9f2ff
    }

    .site-footer a:hover {
      text-decoration: underline
    }

    .footer-logo {
      height: 72px;
      display: block;
      margin-inline: auto
    }

    @media (min-width:1200px) {
      .footer-logo {
        height: 80px
      }
    }

    .badge-row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: .35rem .5rem;
      justify-content: center
    }

    .badge-row img {
      height: 48px
    }

    .duns-img {
      height: 60px;
      max-width: 100%
    }

    .footer-underline {
      height: 2px;
      width: 100%;
      background: rgba(255, 255, 255, .35);
      margin: .4rem 0 1rem
    }

    @media (max-width:991.98px) {
      .site-footer .row>[class*="col-"] {
        text-align: center
      }
    }
  </style>
</head>

<body>
  <div class="container my-3">
    <h1 class="mb-4 my-3 d-flex align-items-center">
      <img src="https://nine9.jic-tools.com.tw/themes/nine9/images/logo.png" alt="Logo" height="100"
        style="margin-right: 10px;">
      <strong class="fw-bold">NC Program Generator for Tapered Thread milling</strong>
    </h1>

    <div class="row">
      <div class="col-md-6">
        <div class="row g-3">

          <div class="col-md-12 my-3 fw-bold">
            <label class="form-label">Thread Family</label>
            <select class="form-select" id="selectTaper" onchange="updateInsertList()">
              <option value="" disabled selected>Select thread family</option>
              <option value="55">55° Tapered Pipe Thread: ISO/JIS-R / PT / Rc / BSPT</option>
              <option value="60">60° Tapered Thread: NPT</option>
            </select>
          </div>
          <!-- <div class="col-md-4 fw-bold">
            <label class="form-label">Thread Size</label>
            <select class="form-select" id="selectThreadSize">
              <option value="" disabled selected>Select Insert first</option>
            </select>
          </div> -->

          <hr class="my-4" />

          <!-- <div class="col-md-6 my-3 fw-bold">
            <label class="form-label">Select Insert</label>
            <select class="form-select" id="selectTool" onchange="updateExtensionOptions()">
              <option value="" disabled selected>Select Insert</option>
              <option value="R05510-09516" style="font-weight:bold;">R05510-09516</option>
              <option value="R05510-10025" style="font-weight:bold;">R05510-10025</option>
              <option value="R06010-09808" style="font-weight:bold;">R06010-09808</option>
              <option value="R06010-10810" style="font-weight:bold;">R06010-10810</option>
            </select>
          </div> -->

          <div class="col-md-6 my-3 fw-bold">
            <label class="form-label">Select Insert</label>
            <select class="form-select" id="selectTool" onchange="updateExtensionOptions()">
              <option value="" disabled selected>Select Insert</option>
            </select>
          </div>

          <div class="col-md-6 my-3 fw-bold">
            <label class="form-label">Workpiece material</label>
            <select class="form-select" id="selectMaterial" onchange="updateCuttingSpeed(); updateSelectColor()">
              <option value="" disabled selected>Select material</option>
              <option value="Material01" style="background-color:#0066CC; color:white; font-weight:bold;">Carbon steel
              </option>
              <option value="Material04" style="background-color:#0066CC; color:white; font-weight:bold;">Alloy steel
              </option>
              <option value="Material06" style="background-color:#FFC000; font-weight:bold;">Stainless steel</option>
              <option value="Material07" style="background-color:#FF0000; color:white; font-weight:bold;">Cast iron
              </option>
              <option value="Material08" style="background-color:#00B050; color:white; font-weight:bold;">Non-ferrous
                metal</option>
              <option value="Material12" style="background-color:#A6A6A6; font-weight:bold;">Hardened steel &lt; HRC50
              </option>
            </select>
          </div>

          <hr class="my-4" />

          <div class="col-md-6 fw-bold ">
            <label class="form-label">Insert Diameter</label>
            <input type="text" class="form-control bg-light" id="toolDiameter" readonly style="cursor:not-allowed;"
              placeholder="Select Insert/mm" oninput="updateSpindleSpeed()">
          </div>
          <div class="col-md-6 fw-bold">
            <label class="form-label">Cutting Speed</label>
            <input type="number" class="form-control" id="vc" placeholder="m/min" oninput="updateSpindleSpeed()" />
          </div>
          <div class="col-md-6 fw-bold">
            <label class="form-label">Spindle Speed</label>
            <input type="number" class="form-control" id="n" placeholder="RPM" readonly
              style="background-color:#d4edda; cursor:not-allowed;" />
          </div>
          <div class="col-md-6 fw-bold">
            <label class="form-label">Number of Teeth</label>
            <input type="number" class="form-control bg-light" style="cursor:not-allowed;" id="z" value="6" readonly
              oninput="updateFeedRate()" />
          </div>
          <div class="col-md-6 fw-bold">
            <label class="form-label">Feed per Tooth</label>
            <input type="number" class="form-control" id="fz" placeholder="mm/tooth" step="0.001"
              oninput="updateFeedRate()" />
          </div>
          <div class="col-md-6 fw-bold">
            <label class="form-label">Feed Rate</label>
            <input type="number" class="form-control" id="vf" placeholder="mm/min" readonly
              style="background-color:#d4edda; cursor:not-allowed;" />
          </div>

          <hr class="my-4" />

          <div class="col-md-6 fw-bold">
            <label class="form-label">Thread Size</label>
            <select class="form-select" id="selectThreadSize">
              <option value="" disabled selected>Select Insert first</option>
            </select>
          </div>
          <div class="col-md-6 fw-bold">
            <label class="form-label">Outer-Dia</label>
            <input type="number" class="form-control" id="od" placeholder="mm" step="0.001" />
          </div>
          <div class="col-md-6 fw-bold">
            <label class="form-label">Tap Drill Diameter</label>
            <input type="number" class="form-control" id="tapDrill" placeholder="mm" step="0.001" />
          </div>
          <div class="col-md-6 fw-bold">
            <label class="form-label">Thread Pitch</label>
            <input type="number" class="form-control" id="pitch" placeholder="mm" />
          </div>
          <div class="col-md-12 fw-bold">
            <label class="form-label">Thread Details</label>
            <textarea id="threadInfo" class="form-control" style="max-height:110px; overflow-y:auto;"
              readonly></textarea>
          </div>

          <hr class="my-4" />

          <div class="col-md-6 fw-bold">
            <label class="form-label">Number Of Passes</label>
            <select class="form-select" id="passes" onchange="updatePassInputs()">
              <option value="1">1</option>
              <option value="2" selected>2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
          <div class="col-12 fw-bold">
            <div class="row" id="passInputs"></div>
          </div>

          <hr class="my-4" />

          <div class="col-md-6 fw-bold">
            <label class="form-label">Depth of Cut</label>
            <input type="number" class="form-control" id="depth" value="16" />
          </div>
          <div class="col-md-6 fw-bold">
            <label class="form-label">Tool Number</label>
            <input type="number" class="form-control" id="toolNo" value="99" />
          </div>
          <div class="col-md-6 fw-bold">
            <label class="form-label">Coordinate System</label>
            <input type="text" class="form-control" id="gcode" value="G54" />
          </div>

          <hr class="my-4" />

          <div class="col-md-6 fw-bold">
            <label class="form-label">Coordinate X</label>
            <input type="number" class="form-control" id="x" value="0" />
          </div>
          <div class="col-md-6 fw-bold">
            <label class="form-label">Coordinate Y</label>
            <input type="number" class="form-control" id="y" value="0" />
          </div>
          <div class="col-md-6 fw-bold">
            <label class="form-label">Safe Height Z</label>
            <input type="number" class="form-control" id="zsafe" value="20" />
          </div>
          <div class="col-md-6 fw-bold">
            <label class="form-label">Surface Coordinate Z</label>
            <input type="number" class="form-control" id="zsurface" value="0" />
          </div>

          <hr class="my-4" />
        </div>
      </div>

      <div class="col-md-6">
        <div class="d-flex justify-content-end mb-2">
          <button class="btn btn-secondary me-2 fw-bold" onclick="addTool(); countClick('addTool')">Add Tool</button>
          <button class="btn btn-primary me-2 fw-bold"
            onclick="calculateGCode(); countClick('calculate')">Generate</button>
          <button class="btn btn-success me-2 fw-bold" onclick="exportToFile(); countClick('export')">Export</button>
          <button class="btn btn-danger fw-bold" onclick="clearOutput(); countClick('clear')">Clear</button>
        </div>
        <textarea id="result" class="form-control my-3" readonly></textarea>
      </div>
    </div>
  </div>

  <footer class="site-footer mt-5">
    <div class="footer-topbar"></div>
    <div class="container py-5">
      <div class="row gy-4 align-items-start">
        <div class="col-12 col-md-6 col-lg-3 text-center">
          <img src="https://nine9.jic-tools.com.tw/upload_files/technology/NC_Program/Jimmore_footer_logo.png"
            alt="JIMMORE" class="footer-logo mb-3 mx-auto d-block">
          <div class="badge-row mb-3">
            <img src="https://nine9.jic-tools.com.tw/upload_files/technology/NC_Program/Jimmore_footer-iso_01.png"
              alt="SGS">
            <img src="https://nine9.jic-tools.com.tw/upload_files/technology/NC_Program/Jimmore_footer-iso_02.png"
              alt="SGS">
            <img src="https://nine9.jic-tools.com.tw/upload_files/technology/NC_Program/Jimmore_footer-iso_03.png"
              alt="UKAS">
          </div>
          <a href="#" target="_blank" rel="noopener">
            <img src="https://www.jic-tools.com.tw/themes/jictools2/images/Jimmore-footer-iso_2.png"
              alt="D-U-N-S Certified" class="duns-img">
          </a>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <div class="footer-underline"></div>
          <address class="mb-0 small lh-lg">
            No.120-2, Sec-2 Fusing Rd., South District,<br>
            Taichung City 402014, Taiwan
          </address>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <div class="footer-underline"></div>
          <p class="small mb-2">
            TEL: <a href="tel:+886422605352" class="link-light text-decoration-none">+886-4-22605352</a><br>
            FAX: +886-4-22608765<br>
            E-mail: <a href="mailto:trade@jimmore.com.tw"
              class="link-light text-decoration-none">trade@jimmore.com.tw</a>
          </p>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <div class="footer-underline"></div>
          <p class="small mb-2">
            Copyright © <span id="year"></span> Jimmore International Corp.<br>
            All Rights Reserved.
          </p>
          <ul class="list-unstyled small mb-0"></ul>
        </div>
      </div>
    </div>
    <script>document.getElementById('year').textContent = (new Date()).getFullYear();</script>
  </footer>

  <script>
    function updateSelectColor() {
      const select = document.getElementById("selectMaterial");
      const selectedOption = select.options[select.selectedIndex];
      select.style.backgroundColor = selectedOption.style.backgroundColor || '';
      select.style.color = selectedOption.style.color || '';
    }
    function countClick() { } // 避免未定義報錯
  </script>

  <script>
    function updatePassInputs() {
      const passCount = parseInt(document.getElementById("passes").value);
      const container = document.getElementById("passInputs");
      container.innerHTML = "";
      for (let i = 0; i < 5; i++) {
        if (i < passCount) {
          const col = document.createElement("div");
          col.className = "col-md-2 text-center";
          const label = document.createElement("label");
          label.className = "form-label";
          const suffix = ["st", "nd", "rd", "th", "th"][i];
          label.textContent = `${i + 1}${suffix} Pass`;
          const input = document.createElement("input");
          input.type = "text";
          input.className = "form-control text-center";
          input.id = `pass${i + 1}`;
          if (i === passCount - 1) {
            input.value = "100%";
            input.readOnly = true;
          } else {
            input.value = "%";
            input.placeholder = "%";
            input.readOnly = false;
          }
          col.appendChild(label);
          col.appendChild(input);
          container.appendChild(col);
        }
      }
    }

    function updateSpindleSpeed() {
      const d = parseFloat(document.getElementById("toolDiameter").value);
      const vc = parseFloat(document.getElementById("vc").value);
      if (!isNaN(d) && d > 0 && !isNaN(vc) && vc > 0) {
        const n = (1000 * vc) / (Math.PI * d);
        document.getElementById("n").value = n.toFixed(0);
      } else {
        document.getElementById("n").value = "";
      }
      updateFeedRate();
    }

    function updateExtensionOptions() {
      const toolSelect = document.getElementById("selectTool");
      const selectedTool = toolSelect.value;
      const Dc = getDcFromTool(selectedTool);
      document.getElementById("toolDiameter").value = Dc;
      updateSpindleSpeed();
      updateThreadSizeOptions(selectedTool);
    }

    const toolThreadMap = {
      "R05510-09516": ["PT 1/4", "PT 3/8"],
      "R05510-10025": ["PT 1/2", "PT 3/4"],
      "R06010-09808": ["NPT 1/4", "NPT 3/8"],
      "R06010-10810": ["NPT 1/2", "NPT 3/4"]
    };

    function updateThreadSizeOptions(toolCode) {
      const threadSelect = document.getElementById("selectThreadSize");
      threadSelect.innerHTML = "";
      const sizes = toolThreadMap[toolCode] || [];
      if (!sizes.length) {
        const option = document.createElement("option");
        option.disabled = true; option.selected = true;
        option.textContent = "此刀具無螺紋建議尺寸";
        threadSelect.appendChild(option);
        return;
      }
      const def = document.createElement("option");
      def.disabled = true; def.selected = true; def.textContent = "select the threading type.";
      threadSelect.appendChild(def);
      sizes.forEach(size => {
        const option = document.createElement("option");
        option.value = size; option.textContent = size;
        threadSelect.appendChild(option);
      });
    }

    function getDcFromTool(code) {
      switch (code) {
        case "R05510-09516": return 9.5;
        case "R05510-10025": return 10.0;
        case "R06010-09808": return 9.8;
        case "R06010-10810": return 10.8;
        default: return 0;
      }
    }

    const cuttingSpeedMap = {
      Material01: { vc: 60.0, fz: 0.005 },
      Material04: { vc: 45.0, fz: 0.005 },
      Material06: { vc: 45.0, fz: 0.005 },
      Material07: { vc: 50.0, fz: 0.005 },
      Material08: { vc: 120.0, fz: 0.0005 },
      Material12: { vc: 30.0, fz: 0.004 }
    };

    function updateCuttingSpeed() {
      const material = document.getElementById("selectMaterial").value;
      const vcInput = document.getElementById("vc");
      const fzInput = document.getElementById("fz");
      const data = cuttingSpeedMap[material];
      if (data) {
        vcInput.value = data.vc;
        fzInput.value = data.fz;
        updateSpindleSpeed();
      } else {
        vcInput.value = "";
        fzInput.value = "";
      }
    }

    function updateFeedRate() {
      const z = parseFloat(document.getElementById("z").value);
      const fz = parseFloat(document.getElementById("fz").value);
      const n = parseFloat(document.getElementById("n").value);
      if (!isNaN(z) && !isNaN(fz) && !isNaN(n) && z > 0 && fz > 0 && n > 0) {
        const vf = n * fz * z;
        document.getElementById("vf").value = vf.toFixed(2);
      } else {
        document.getElementById("vf").value = "";
      }
    }

    function addTool() {
      const toolNo = document.getElementById("toolNo").value;
      const spindleSpeed = document.getElementById("n").value;
      const gcode = `G17 G21 G49 G80\nT${toolNo} M06\nS${spindleSpeed} M03\nM08\n`;
      document.getElementById("result").value += gcode + "\n";
    }

    function clearOutput() {
      document.getElementById("result").value = "";
    }

    function exportToFile() {
      let content = document.getElementById("result").value;
      content += "\nM05\nM09\nG91 G28 Z0.\nG91 G28 Y0.\nM30";
      const blob = new Blob([content], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "ParallelThread_NCCode.txt";
      a.click();
    }

    document.getElementById("selectThreadSize").addEventListener("change", function () {
      const selectedThread = this.value;
      const data = threadData[selectedThread];
      if (data) {
        document.getElementById("pitch").value = data.Pitch;
        document.getElementById("od").value = data.MajorDiameter;
        document.getElementById("tapDrill").value = data.TapDrillDiameter;
        const infoText = `Thread: ${selectedThread}
Major Diameter: ${data.MajorDiameter} mm
Pitch: ${data.Pitch} mm
Tap Drill Diameter: ${data.TapDrillDiameter} mm`;
        document.getElementById("threadInfo").value = infoText;
      }
    });

    const P = tpi => Number((25.4 / tpi).toFixed(3));
    const threadData = {
      "PT 1/4": { MajorDiameter: 13.157, Pitch: P(19), TapDrillDiameter: 11.113 },
      "PT 3/8": { MajorDiameter: 16.662, Pitch: P(19), TapDrillDiameter: 14.684 },
      "PT 1/2": { MajorDiameter: 20.955, Pitch: P(14), TapDrillDiameter: 18.256 },
      "PT 3/4": { MajorDiameter: 26.441, Pitch: P(14), TapDrillDiameter: 23.813 },

      "NPT 1/4": { MajorDiameter: 12.487, Pitch: P(18), TapDrillDiameter: 11.113 },
      "NPT 3/8": { MajorDiameter: 15.926, Pitch: P(18), TapDrillDiameter: 14.288 },
      "NPT 1/2": { MajorDiameter: 19.772, Pitch: P(14), TapDrillDiameter: 17.859 },
      "NPT 3/4": { MajorDiameter: 25.117, Pitch: P(14), TapDrillDiameter: 23.019 },
    };

    window.onload = updatePassInputs;
  </script>

  <script>
    // 依牙型家族對應可選的刀片
    const toolGroups = {
      '55': [
        { v: 'R05510-09516', t: 'R05510-09516' },
        { v: 'R05510-10025', t: 'R05510-10025' },
      ],
      '60': [
        { v: 'R06010-09808', t: 'R06010-09808' },
        { v: 'R06010-10810', t: 'R06010-10810' },
      ]
    };

    // 牙型家族改變 → 重建「Select Insert」內容
    function updateInsertList() {
      const fam = document.getElementById('selectTaper').value;     // '55' or '60'
      const toolSel = document.getElementById('selectTool');
      toolSel.innerHTML = '<option value="" disabled selected>Select Insert</option>';

      // 清空已帶入的刀徑與螺紋尺寸
      document.getElementById('toolDiameter').value = '';
      document.getElementById('selectThreadSize').innerHTML =
        '<option value="" disabled selected>Select Insert first</option>';

      if (!fam || !toolGroups[fam]) return;

      toolGroups[fam].forEach(o => {
        const opt = document.createElement('option');
        opt.value = o.v;
        opt.textContent = o.t;
        opt.style.fontWeight = 'bold';
        toolSel.appendChild(opt);
      });

      // 若想切換家族後自動選第一個並帶入刀徑，取消註解下兩行
      // toolSel.selectedIndex = 1;
      // updateExtensionOptions();
    }

    // 如果你原本用 window.onload = updatePassInputs; 會被覆蓋，改成 addEventListener
    window.addEventListener('load', () => {
      updatePassInputs();            // 你原本的初始化
      // 可選：預設先選 55° 家族並帶入第一個刀片
      // document.getElementById('selectTaper').value = '55';
      // updateInsertList();
    });
  </script>


  <script>
    function calculateGCode() {
      try {
        const num = id => Number(document.getElementById(id)?.value);
        function val(id, fallback) {
          const el = document.getElementById(id);
          if (el && el.value !== '') {
            const n = Number(el.value);
            return isNaN(n) ? el.value : n;
          }
          const map = {
            v21: document.getElementById('gcode')?.value,
            v24: num('x'),
            v25: num('y'),
            v26: num('zsafe'),
            v18: num('zsurface'),
            v4120: num('toolNo'),
            v4119: num('n'),
            v9: num('fz'),
            OD: num('od'),
            pitch: num('pitch'),
            teeth: num('z'),
            v102: num('toolDiameter'),
            v17: num('depth')
          };
          if (Object.prototype.hasOwnProperty.call(map, id) &&
            map[id] != null && map[id] !== '' && !Number.isNaN(map[id])) {
            return map[id];
          }
          return fallback;
        }
        const deg2rad = d => d * Math.PI / 180;

        // ===== 讀入 =====
        const v21 = (val('v21', 'G54') + '').toUpperCase(); // #21
        const v24 = Number(val('v24', 0));                  // Xc
        const v25 = Number(val('v25', 0));                  // Yc
        const v26 = Number(val('v26', 20));                 // Zsafe
        const v18 = Number(val('v18', 0));                  // Zsurface
        const v4120 = val('v4120', 99);                       // H
        const v4119 = val('v4119', null);                     // N rpm
        const v9 = val('v9', null);                        // fz
        const teeth = val('teeth', 6) || 6;                   // 刀刃數
        const v102 = val('v102', null);                      // 刀徑
        const v17 = Number(val('v17', 10));                 // Depth of Cut (正值)

        if (!v102 || v102 <= 0) throw new Error('缺少刀徑 (Insert Diameter)');
        if (!v17 || v17 <= 0) throw new Error('Depth of Cut 必須 > 0');

        const OD = val('OD', null);
        const pitchIn = val('pitch', null);
        const tapDrill = num('tapDrill');

        if (OD == null || isNaN(OD)) throw new Error('請提供外徑 (OD)');
        if (pitchIn == null || isNaN(pitchIn)) throw new Error('請提供螺距 (Pitch)');
        if (isNaN(tapDrill)) throw new Error('請提供 Tap Drill Diameter');

        // 選擇的牙型，用來判斷是否為錐度（PT/NPT）
        const threadSel = (document.getElementById('selectThreadSize')?.value || '').trim();
        const isTaper = /^PT|^NPT/i.test(threadSel);

        // 幾何常數
        const P = Number(pitchIn);        // 螺距
        const stepDeg = 10;               // 每步角度，可視需求調整
        const liftZ = 1.5 * P;          // 起刀抬高
        // 錐度：直徑 1:16 → 半徑 1:32；每轉一圈（下降 P），半徑縮小 P/32
        const taperRPerLen = isTaper ? (1 / 32) : 0;      // 每 1mm 深度，半徑改變多少
        const dR_per_rev = P * taperRPerLen;          // 每轉一圈半徑變化量（mm）

        // 進給 F = N * fz * 齒數（若缺值則不帶 F）
        const feed = (v4119 != null && v9 != null) ? (v4119 * v9 * teeth) : null;

        // 以刀具中心的半徑：由鑽孔徑到完成徑
        const R_finish = (OD - v102) / 2;
        const R_start = (tapDrill - v102) / 2;
        if (R_finish <= 0) throw new Error('外徑需大於刀徑');
        if (R_start < 0) throw new Error('Tap Drill 需大於刀徑');

        const passCount = parseInt(document.getElementById("passes").value) || 1;

        const out = [];
        // 到中心 & 安全高度
        out.push(`G90 ${v21} G00 X${v24.toFixed(3)} Y${v25.toFixed(3)}`);
        out.push(`G43 Z${v26.toFixed(3)} H${v4120}`);

        for (let i = 1; i <= passCount; i++) {
          // 解析分刀百分比
          const passInput = document.getElementById(`pass${i}`);
          let percent = 100;
          if (passInput) {
            const txt = (passInput.value || '').replace('%', '').trim();
            if (txt !== '') {
              percent = Number(txt);
              if (isNaN(percent) || percent <= 0 || percent > 100) {
                throw new Error(`第 ${i} 刀路深度百分比格式錯誤`);
              }
            }
          }

          // 該刀的「目標工作半徑」（介於 R_start ~ R_finish）
          const R_base = R_start + (R_finish - R_start) * (percent / 100);

          // 宏內對應：#112 = R_base；#115 = #112 + ((P*(1/32))*1.5) → 先把起刀半徑往外加一點
          const R_entry = R_base + (P * (1 / 32) * 1.5);
          const Y_entry = 0;

          // 起點（+X 方向），Z 抬高 1.5P
          out.push(`G90 G00 X${(v24 + R_entry).toFixed(3)} Y${(v25 + Y_entry).toFixed(3)} Z${(v18 + liftZ).toFixed(3)}`);

          // 螺旋循環
          let angle = 0;                  // 累計角度（度）
          let loopGuard = 0;
          let feedOnce = true;
          let lastR = R_entry;

          while (true) {
            angle += stepDeg;                                 // 每次走 stepDeg
            const rev = angle / 360;                          // 轉數
            const zOff = (-P) * rev + liftZ;                  // 相對 Z：每圈下降 P，初始 +1.5P
            const Rnow = R_entry - (isTaper ? dR_per_rev * rev : 0); // 錐度：半徑隨圈數縮小
            const xOff = Math.cos(deg2rad(angle)) * Rnow;
            const yOff = -Math.sin(deg2rad(angle)) * Rnow;    // 右旋 G02，Y 取負

            const X = (v24 + xOff).toFixed(3);
            const Y = (v25 + yOff).toFixed(3);
            const Z = (v18 + zOff).toFixed(3);

            const ftxt = (feed && feedOnce) ? ` F${feed.toFixed(1)}` : ``;
            out.push(`G90 G02 X${X} Y${Y} Z${Z} R${Rnow.toFixed(3)}${ftxt}`);
            feedOnce = false;
            lastR = Rnow;

            if (Math.abs(zOff) >= v17) break;                 // 深度達成
            if (++loopGuard > 20000) throw new Error('Angle 迴圈過多，請檢查 stepDeg/P/Depth 參數');
          }

          // 收刀到中心 & 回安全
          out.push(`G90 G02 X${v24.toFixed(3)} Y${v25.toFixed(3)} R${(lastR * 0.501).toFixed(3)}`);
          out.push(`G90 G01 Z${v18.toFixed(3)} F1500.`);
          out.push(`G90 G00 Z${v26.toFixed(3)}`);
        }

        document.getElementById("result").value += out.join('\n') + '\n';

      } catch (err) {
        alert("計算錯誤：" + err.message);
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>