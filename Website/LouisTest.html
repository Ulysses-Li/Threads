<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QR æƒæ â†’ è‡ªå‹•å¡«å…¥ â†’ é€åˆ°é›»è…¦ï¼ˆç›´é€£ / ç¶“ç”±ä»£ç†ï¼‰</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" />
<style>
  body{background:#0b1220;color:#e5e7eb}
  .card{border-radius:1rem}
  video,canvas{width:100%;border-radius:.75rem;background:#111827}
  .hint{color:#94a3b8}
  pre{white-space:pre-wrap;word-break:break-all}
  .kbd{padding:.1rem .35rem;border:1px solid #666;border-radius:.25rem;background:#111}
  .toast{background:#111827;color:#e5e7eb;border:1px solid #334155}
  .form-switch .form-check-input{cursor:pointer}
</style>
</head>
<body>
<div class="container py-4">
  <h1 class="h4 mb-3">ğŸ“± QR æƒæ â†’ è‡ªå‹•å¡«å…¥ â†’ é€åˆ°é›»è…¦ <span class="badge bg-secondary">v2</span></h1>
  <p class="hint mb-3">
    å»ºè­°åœ¨ <b>åŒä¸€ä¾†æº</b>ï¼ˆä¾‹å¦‚ <span class="kbd">http://&lt;é›»è…¦IP&gt;:54321/ui</span>ï¼‰é–‹å•Ÿæœ¬é ã€‚<br>
    è‹¥ä½ å¾ GitHub Pagesï¼ˆHTTPSï¼‰é–‹å•Ÿï¼Œç›´æ¥é€£ <span class="kbd">http://192.168.â€¦</span> å¸¸è¢«ç€è¦½å™¨å°é–ï¼›å¯åˆ‡æ› <b>ç¶“ç”±ä»£ç†</b> æ¨¡å¼ã€‚
  </p>

  <!-- è¨­å®šåˆ— -->
  <div class="card bg-dark border-0 shadow mb-4">
    <div class="card-body row g-3 align-items-end">
      <div class="col-12 col-xl-5">
        <label class="form-label">é€å‡ºç«¯é»ï¼ˆé è¨­åŒæº <span class="kbd">/fill</span>ï¼‰</label>
        <input id="endpoint" class="form-control form-control-sm" placeholder="/fill æˆ– http://192.168.x.x:54321/fill">
        <div class="form-text text-secondary">æœƒè¨˜ä½åœ¨æœ¬æ©Ÿè£ç½®ï¼ˆlocalStorageï¼‰ã€‚</div>
      </div>
      <div class="col-12 col-md-6 col-xl-3">
        <label class="form-label">å‚³é€æ¨¡å¼</label>
        <div class="d-flex gap-3 flex-wrap">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="modeSend" id="modeDirect" value="direct" checked>
            <label class="form-check-label" for="modeDirect">ç›´é€£ï¼ˆåŒç¶²æ®µå»ºè­°ï¼‰</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="modeSend" id="modeProxy" value="proxy">
            <label class="form-check-label" for="modeProxy">ç¶“ç”±ä»£ç†ï¼ˆçµ¦ HTTPS â†’ å…§ç¶²ï¼‰</label>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-xl-4" id="proxyWrap" style="display:none">
        <label class="form-label">ä»£ç†ï¼ˆBridgeï¼‰URL</label>
        <input id="proxyUrl" class="form-control form-control-sm" placeholder="https://ä½ çš„ä»£ç†ç¶²åŸŸ/bridge">
        <div class="form-text text-secondary">ä»£ç†ä¼ºæœå™¨æœƒä»£ç‚ºå­˜å– endpointï¼ˆéœ€ä½ è‡ªè¡Œéƒ¨ç½²ï¼‰ã€‚</div>
      </div>

      <div class="col-6 col-md-3 col-xl-2">
        <label class="form-label">é¡é ­</label>
        <select id="camFacing" class="form-select form-select-sm">
          <option value="environment" selected>å¾Œé¡é ­</option>
          <option value="user">å‰é¡é ­</option>
        </select>
      </div>
      <div class="col-6 col-md-3 col-xl-2">
        <label class="form-label">HTTP æ–¹æ³•</label>
        <select id="httpMethod" class="form-select form-select-sm">
          <option value="GET" selected>GETï¼ˆqueryï¼‰</option>
          <option value="POST">POSTï¼ˆJSONï¼‰</option>
        </select>
      </div>
      <div class="col-12 col-md-6 col-xl-3">
        <div class="form-check form-switch">
          <input id="autoSend" class="form-check-input" type="checkbox" checked>
          <label class="form-check-label" for="autoSend">æƒåˆ°è‡ªå‹•é€å‡º</label>
        </div>
        <div class="form-check form-switch">
          <input id="clearOnSend" class="form-check-input" type="checkbox">
          <label class="form-check-label" for="clearOnSend">é€å‡ºå¾Œæ¸…ç©ºæ¬„ä½</label>
        </div>
      </div>
      <div class="col-12 col-md-6 col-xl-3 d-grid gap-2">
        <button id="btnPing" class="btn btn-outline-info btn-sm">Ping æ¸¬è©¦</button>
        <button id="btnSaveCfg" class="btn btn-outline-secondary btn-sm">å„²å­˜è¨­å®š</button>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- å·¦ï¼šç›¸æ©Ÿ -->
    <div class="col-12 col-lg-7">
      <div class="card bg-dark border-0 shadow">
        <div class="card-body">
          <div class="d-flex gap-2 flex-wrap mb-3">
            <button id="btnStart" class="btn btn-success btn-sm">é–‹å§‹æƒæ</button>
            <button id="btnStop" class="btn btn-outline-light btn-sm" disabled>åœæ­¢</button>
            <span class="hint">iOS éœ€åœ¨ HTTPS æˆ– localhost é–‹å•Ÿä»¥å…è¨±ç›¸æ©Ÿã€‚</span>
          </div>
          <div class="ratio ratio-4x3 mb-2">
            <video id="preview" playsinline muted></video>
          </div>
          <canvas id="work" class="d-none"></canvas>
          <div id="camNote" class="hint">è‹¥ç•«é¢æœªæ’­æ”¾ï¼Œè«‹å†æŒ‰ã€Œé–‹å§‹æƒæã€ï¼Œæˆ–æª¢æŸ¥ç›¸æ©Ÿæ¬Šé™ã€‚</div>
        </div>
      </div>
    </div>

    <!-- å³ï¼šçµæœï¼‹æ‰‹å‹•æ¬„ä½ï¼‹é€å‡º -->
    <div class="col-12 col-lg-5">
      <div class="card bg-dark border-0 shadow mb-4">
        <div class="card-body">
          <h2 class="h6">æƒæçµæœ</h2>
          <pre id="scanText" class="p-2 bg-black rounded" style="min-height:5.5rem">ï¼ˆå°šæœªæƒåˆ°å…§å®¹ï¼‰</pre>
          <div class="d-flex gap-2 flex-wrap">
            <button id="btnCopy" class="btn btn-primary btn-sm" disabled>è¤‡è£½çµæœ</button>
            <a id="btnOpen" class="btn btn-outline-info btn-sm disabled" target="_blank" rel="noopener">åœ¨æ–°åˆ†é é–‹å•Ÿï¼ˆè‹¥ç‚ºç¶²å€ï¼‰</a>
            <button id="btnParse" class="btn btn-outline-warning btn-sm">é‡è§£æ â†’ å¡«å…¥</button>
          </div>
        </div>
      </div>

      <div class="card bg-dark border-0 shadow">
        <div class="card-body">
          <h2 class="h6">è¦é€åˆ°é›»è…¦çš„äº”å€‹æ¬„ä½</h2>
          <div class="row g-2">
            <div class="col-12"><input id="tb1" class="form-control form-control-sm" placeholder="tb1ï¼šä¾‹ å–®è™Ÿ"></div>
            <div class="col-12"><input id="tb2" class="form-control form-control-sm" placeholder="tb2ï¼šä¾‹ æ–™è™Ÿ"></div>
            <div class="col-12"><input id="tb3" class="form-control form-control-sm" placeholder="tb3ï¼šä¾‹ æ‰¹è™Ÿ"></div>
            <div class="col-12"><input id="tb4" class="form-control form-control-sm" placeholder="tb4ï¼šä¾‹ æ•¸é‡"></div>
            <div class="col-12"><input id="tb5" class="form-control form-control-sm" placeholder="tb5ï¼šä¾‹ å‚™è¨»"></div>
          </div>
          <div class="d-flex gap-2 flex-wrap mt-3 align-items-center">
            <button id="btnSend" class="btn btn-success btn-sm">é€å‡ºåˆ°é›»è…¦</button>
            <input id="token" class="form-control form-control-sm" style="max-width:12rem" placeholder="å¯é¸ token">
            <input id="sep" class="form-control form-control-sm" style="max-width:8rem" placeholder="åˆ†éš”ç¬¦(å¯ç©º)">
            <span class="hint">è‹¥ QR æ˜¯å–®è¡Œå­—ä¸²ï¼Œå¯è¨­å®šåˆ†éš”ç¬¦ï¼ˆå¦‚ <b>|</b> æˆ– <b>,</b>ï¼‰ã€‚</span>
          </div>
          <hr class="border-secondary">
          <div>
            <label class="form-label">å‚™ç”¨ï¼šå¾ç›¸ç°¿é¸æ“‡åœ–ç‰‡</label>
            <input id="fileInput" type="file" accept="image/*" capture="environment" class="form-control" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="mt-4 hint">
    <hr class="border-secondary">
    <small>Â© 2025 QRâ†’å¡«å…¥â†’é€å‡ºã€‚æ”¯æ´ querystring / CSV / pipe / ç©ºç™½ / JSON è‡ªå‹•è§£æã€‚å·²å…§å»ºã€Œç›´é€£ã€èˆ‡ã€Œç¶“ç”±ä»£ç†ã€å…©ç¨®å‚³è¼¸æ¨¡å¼ã€‚</small>
  </footer>
</div>

<!-- Toast for warnings -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
  <div id="toast" class="toast align-items-center" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div id="toastBody" class="toast-body"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
<script>
let stream=null, scanning=false;
const $=id=>document.getElementById(id);
const els={ preview:$('preview'), work:$('work'),
  btnStart:$('btnStart'), btnStop:$('btnStop'),
  scanText:$('scanText'), btnCopy:$('btnCopy'), btnOpen:$('btnOpen'),
  btnParse:$('btnParse'), fileInput:$('fileInput'),
  tb1:$('tb1'), tb2:$('tb2'), tb3:$('tb3'), tb4:$('tb4'), tb5:$('tb5'),
  btnSend:$('btnSend'), token:$('token'), sep:$('sep'),
  endpoint:$('endpoint'),
  modeDirect:$('modeDirect'), modeProxy:$('modeProxy'), proxyUrl:$('proxyUrl'), proxyWrap: document.getElementById('proxyWrap'),
  camFacing:$('camFacing'), httpMethod:$('httpMethod'),
  autoSend:$('autoSend'), clearOnSend:$('clearOnSend'),
  btnPing:$('btnPing'), btnSaveCfg:$('btnSaveCfg'),
};

const toastEl = document.getElementById('toast');
const toastBody = document.getElementById('toastBody');
const showToast = (msg)=>{ toastBody.textContent = msg; new bootstrap.Toast(toastEl,{delay:5000}).show(); };

// --- åˆå§‹åŒ–ï¼šè¼‰å…¥è¨­å®š ---
(function initConfig(){
  const savedEP = localStorage.getItem('qr_endpoint');
  const savedMode = localStorage.getItem('qr_modeSend');
  const savedProxy = localStorage.getItem('qr_proxyUrl');
  const savedMethod = localStorage.getItem('qr_httpMethod');

  const defaultEP = '/fill';
  els.endpoint.value = savedEP || defaultEP;
  if(savedMode === 'proxy'){ els.modeProxy.checked=true; els.proxyWrap.style.display='block'; }
  els.proxyUrl.value = savedProxy || '';
  if(savedMethod){ els.httpMethod.value = savedMethod; }
})();
els.btnSaveCfg.onclick=()=>{
  localStorage.setItem('qr_endpoint', els.endpoint.value.trim());
  localStorage.setItem('qr_modeSend', els.modeProxy.checked ? 'proxy' : 'direct');
  localStorage.setItem('qr_proxyUrl', els.proxyUrl.value.trim());
  localStorage.setItem('qr_httpMethod', els.httpMethod.value);
  alert('è¨­å®šå·²å„²å­˜');
};

// åˆ‡æ›é¡¯ç¤ºä»£ç†è¼¸å…¥æ¡†
els.modeDirect.addEventListener('change', ()=>{ if(els.modeDirect.checked){ els.proxyWrap.style.display='none'; } });
els.modeProxy.addEventListener('change', ()=>{ if(els.modeProxy.checked){ els.proxyWrap.style.display='block'; } });

// å®‰å…¨æ€§æç¤ºï¼ˆHTTPS é é¢ç›´é€£ HTTP å…§ç¶²ï¼‰
function maybeWarnMixed(){
  try{
    const ep = (els.endpoint.value||'').trim();
    if(location.protocol==='https:' && els.modeDirect.checked && /^http:\/\//i.test(ep)){
      showToast('ç›®å‰é é¢ç‚º HTTPSï¼Œç›´é€£ HTTP å…§ç¶²ç«¯é»å¯èƒ½è¢«ç€è¦½å™¨å°é–ã€‚è«‹æ”¹ç”¨ã€Œç¶“ç”±ä»£ç†ã€æˆ–åœ¨åŒç¶²æ®µä»¥ HTTP é–‹å•Ÿæœ¬é ã€‚');
    }
  }catch(_){}
}

// --- ç›¸æ©Ÿæ§åˆ¶ ---
function setUI(r){ els.btnStart.disabled=r; els.btnStop.disabled=!r; }
function stop(){ scanning=false; if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } setUI(false); }
async function start(){
  try{
    stop();
    const facing = els.camFacing.value||'environment';
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ideal:facing}, width:{ideal:1280}, height:{ideal:720} }, audio:false
    });
    els.preview.srcObject=stream; await els.preview.play();
    scanning=true; setUI(true); requestAnimationFrame(tick);
  }catch(err){ alert('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼š'+(err?.message||err)); stop(); }
}
els.btnStart.onclick=start; els.btnStop.onclick=stop; els.camFacing.onchange=()=>{ if(scanning) start(); };

// --- æƒæå¾ªç’° ---
function tick(){
  if(!scanning) return;
  const v=els.preview;
  if(v.readyState===v.HAVE_ENOUGH_DATA){
    const c=els.work, w=v.videoWidth, h=v.videoHeight;
    c.width=w; c.height=h; const ctx=c.getContext('2d');
    ctx.drawImage(v,0,0,w,h);
    const img = ctx.getImageData(0,0,w,h);
    const code = jsQR(img.data,w,h,{inversionAttempts:'dontInvert'});
    if(code && code.data){
      showScan(code.data); stop();
      tryFill(code.data);  // è‡ªå‹•è§£æ â†’ å¡«å…¥
      if(els.autoSend.checked) send();
      return;
    }
  }
  requestAnimationFrame(tick);
}

// --- é¡¯ç¤º/è§£æ ---
function showScan(text){
  els.scanText.textContent = text||'ï¼ˆæ²’æœ‰å…§å®¹ï¼‰';
  els.btnCopy.disabled = !text;
  if(/^https?:\/\//i.test(text)){ els.btnOpen.classList.remove('disabled'); els.btnOpen.href=text; }
  else { els.btnOpen.classList.add('disabled'); els.btnOpen.removeAttribute('href'); }
}
els.btnCopy.onclick=async()=>{ try{ await navigator.clipboard.writeText(els.scanText.textContent.trim()); }catch(_){} };

// è§£æè¦å‰‡ï¼šquerystring(tb1~tb5) > JSON(éµ/é™£åˆ—) > åˆ†éš”ç¬¦ > ç©ºç™½åˆ‡5 > CSV
function tryFill(raw){
  const text = (raw||'').trim();
  if(!text){ return; }

  // 1) querystringï¼ˆURL?tb1=...&tb2=...ï¼‰
  try{
    const u = new URL(text);
    const qs = u.searchParams;
    const v1=qs.get('tb1'), v2=qs.get('tb2'), v3=qs.get('tb3'), v4=qs.get('tb4'), v5=qs.get('tb5');
    if(v1||v2||v3||v4||v5){ setTB(v1,v2,v3,v4,v5); return; }
  }catch(_){/* é URL */}
  if(text.includes('=')){ // ç´” querystring å½¢å¼ tb1=...&tb2=...
    const qs = new URLSearchParams(text);
    const v1=qs.get('tb1'), v2=qs.get('tb2'), v3=qs.get('tb3'), v4=qs.get('tb4'), v5=qs.get('tb5');
    if(v1||v2||v3||v4||v5){ setTB(v1,v2,v3,v4,v5); return; }
  }

  // 2) JSON
  if(text.startsWith('{') || text.startsWith('[')){
    try{
      const obj = JSON.parse(text);
      if(Array.isArray(obj) && obj.length===5){ setTB(obj[0],obj[1],obj[2],obj[3],obj[4]); return; }
      if(obj && typeof obj==='object'){
        const v1=obj.tb1??obj.TB1??obj.Tb1, v2=obj.tb2??obj.TB2??obj.Tb2, v3=obj.tb3??obj.TB3??obj.Tb3,
              v4=obj.tb4??obj.TB4??obj.Tb4, v5=obj.tb5??obj.TB5??obj.Tb5;
        if(v1||v2||v3||v4||v5){ setTB(v1,v2,v3,v4,v5); return; }
      }
    }catch(_){ }
  }

  // 3) æŒ‡å®šåˆ†éš”ç¬¦
  const sep = els.sep.value;
  if(sep){
    const parts = text.split(sep);
    if(parts.length>=5){ setTB(parts[0],parts[1],parts[2],parts[3],parts[4]); return; }
  }

  // 4) å¸¸è¦‹åˆ†éš”ç¬¦ï¼ˆ|ã€é€—è™Ÿã€ç©ºç™½ï¼‰
  for(const s of ['|',',',' ']){
    const arr = text.split(s).filter(x=>x.length>0);
    if(arr.length>=5){ setTB(arr[0],arr[1],arr[2],arr[3],arr[4]); return; }
  }

  // 5) è½ç©ºï¼šåªå¡ tb1
  setTB(text,'','','','');
}
function setTB(a,b,c,d,e){
  els.tb1.value=a??''; els.tb2.value=b??''; els.tb3.value=c??''; els.tb4.value=d??''; els.tb5.value=e??'';
}
els.btnParse.onclick=()=>tryFill(els.scanText.textContent.trim());

// åœ–ç‰‡å‚™æ´
els.fileInput.addEventListener('change', e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const imgEl = new Image();
  imgEl.onload=()=>{
    const c=els.work; c.width=imgEl.naturalWidth; c.height=imgEl.naturalHeight;
    const ctx=c.getContext('2d'); ctx.drawImage(imgEl,0,0);
    const img=ctx.getImageData(0,0,c.width,c.height);
    const code=jsQR(img.data,c.width,c.height,{inversionAttempts:'dontInvert'});
    if(code && code.data){ showScan(code.data); tryFill(code.data); if(els.autoSend.checked) send(); }
    else { showScan('ï¼ˆåœ–ç‰‡æœªåµæ¸¬åˆ° QRï¼‰'); }
  };
  imgEl.onerror=()=>showScan('ï¼ˆåœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼‰');
  imgEl.src=URL.createObjectURL(f);
});

// ç”¢ç”Ÿ payload
function buildPayload(){
  const payload = {
    tb1: els.tb1.value||'',
    tb2: els.tb2.value||'',
    tb3: els.tb3.value||'',
    tb4: els.tb4.value||'',
    tb5: els.tb5.value||'',
  };
  const token = (els.token.value||'').trim();
  if(token) payload.token = token;
  return payload;
}

// --- å‚³é€ï¼ˆç›´é€£ or ç¶“ç”±ä»£ç†ï¼‰---
async function send(){
  const base = (els.endpoint.value||'').trim() || '/fill';
  const mode = els.modeProxy.checked ? 'proxy' : 'direct';
  const method = els.httpMethod.value;
  maybeWarnMixed();

  const data = buildPayload();
  try{
    let respText = '';
    if(mode==='direct'){
      if(method==='GET'){
        const p = new URLSearchParams(data);
        const r = await fetch(base + '?' + p.toString(), { method:'GET' });
        respText = await r.text();
      }else{ // POST JSON
        const r = await fetch(base, {
          method:'POST', headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(data)
        });
        respText = await r.text();
      }
    }else{ // proxy mode
      const proxy = (els.proxyUrl.value||'').trim();
      if(!proxy){ alert('è«‹å…ˆå¡«å…¥ä»£ç†ï¼ˆBridgeï¼‰URL'); return; }
      const r = await fetch(proxy, {
        method:'POST', headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ target: base, method, payload: data })
      });
      respText = await r.text();
    }

    alert('å›æ‡‰ï¼š' + respText);
    if(els.clearOnSend.checked){ setTB('','','','',''); }
  }catch(e){
    alert('é€å‡ºå¤±æ•—ï¼š' + (e?.message||e));
  }
}
els.btnSend.onclick=send;

// --- Ping æ¸¬è©¦ï¼ˆ/fill â†’ /pingï¼‰---
async function doPing(){
  let ep = (els.endpoint.value||'').trim() || '/fill';
  ep = ep.replace(/\/?fill\/?$/i,'/ping');
  const mode = els.modeProxy.checked ? 'proxy' : 'direct';
  maybeWarnMixed();

  try{
    let text='';
    if(mode==='direct'){
      const r = await fetch(ep, { method:'GET' });
      text = await r.text();
    }else{
      const proxy = (els.proxyUrl.value||'').trim();
      if(!proxy){ alert('è«‹å…ˆå¡«å…¥ä»£ç†ï¼ˆBridgeï¼‰URL'); return; }
      const r = await fetch(proxy, {
        method:'POST', headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ target: ep, method:'GET' })
      });
      text = await r.text();
    }
    alert('Ping å›æ‡‰ï¼š' + text);
  }catch(e){ alert('Ping å¤±æ•—ï¼š' + (e?.message||e)); }
}
els.btnPing.onclick=doPing;
</script>
</body>
</html>
