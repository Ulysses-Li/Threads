<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ‰‹æ©Ÿç›¸æ©Ÿå–ç”¨ï¼ˆBootstrap 5ï¼‰</title>

  <!-- Bootstrap 5 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" />

  <style>
    body { background: #0f172a; color: #e2e8f0; }
    .card { border-radius: 1rem; }
    video, canvas, img { width: 100%; border-radius: .75rem; background: #111827; }
    .device-select { max-width: 520px; }
    .hint { color: #94a3b8; font-size: .95rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .btn-wrap { gap: .5rem; flex-wrap: wrap; }
  </style>
</head>
<body>
  <div class="container py-4">
    <header class="mb-4">
      <h1 class="h3 mb-1">ğŸ“· æ‰‹æ©Ÿç›¸æ©Ÿå–ç”¨ Demo</h1>
      <p class="hint mb-0">éœ€åœ¨ <span class="mono">HTTPS</span> æˆ–æœ¬æ©Ÿ <span class="mono">localhost</span> ä¸Šé–‹å•Ÿã€‚iOS Safari è«‹é—œé–‰ã€Œä½è€—é›»æ¨¡å¼ã€ã€‚</p>
    </header>

    <div class="row g-4">
      <div class="col-12 col-lg-8">
        <div class="card bg-dark border-0 shadow">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <div class="device-select w-100 me-2">
                <label for="cameraSelect" class="form-label mb-1">é¸æ“‡ç›¸æ©Ÿï¼ˆå¦‚æœ‰å¤šé¡é ­ï¼‰</label>
                <select id="cameraSelect" class="form-select form-select-sm"></select>
              </div>
              <div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="mirror" checked>
                  <label class="form-check-label" for="mirror">é¡åƒé¡¯ç¤º</label>
                </div>
              </div>
            </div>

            <div class="ratio ratio-4x3 mb-3">
              <video id="preview" playsinline muted></video>
            </div>

            <div class="d-flex btn-wrap">
              <button id="btnStart" class="btn btn-success btn-sm">å•Ÿå‹•ç›¸æ©Ÿ</button>
              <button id="btnStop" class="btn btn-outline-light btn-sm" disabled>åœæ­¢ç›¸æ©Ÿ</button>
              <button id="btnSwitch" class="btn btn-primary btn-sm" disabled>åˆ‡æ›å‰/å¾Œé¡é ­</button>
              <button id="btnTorch" class="btn btn-outline-warning btn-sm" disabled>æ‰‹é›»ç­’</button>
              <button id="btnShot" class="btn btn-info btn-sm" disabled>æ‹ç…§</button>
              <a id="btnDownload" class="btn btn-outline-info btn-sm disabled" download="capture.jpg">ä¸‹è¼‰ç…§ç‰‡</a>
            </div>

            <div class="mt-3 hint">
              <details>
                <summary class="mb-2">å¸¸è¦‹ç‹€æ³èˆ‡è§£æ³•</summary>
                <ul class="mb-0">
                  <li>ç¬¬ä¸€æ¬¡ä½¿ç”¨éœ€æˆæ¬Šç›¸æ©Ÿæ¬Šé™ï¼›è‹¥è¢«æ‹’ï¼Œå¯è‡³ç€è¦½å™¨è¨­å®š â†’ ç¶²ç«™è¨­å®š â†’ ç›¸æ©Ÿ â†’ å…è¨±ã€‚</li>
                  <li>iOS Safari éœ€ <span class="mono">playsinline</span> èˆ‡ <span class="mono">muted</span> æ‰èƒ½è‡ªå‹•æ’­æ”¾é è¦½ã€‚</li>
                  <li>æŸäº›è£ç½®ä¸æ”¯æ´æ‰‹é›»ç­’æˆ–åˆ‡æ›é¡é ­ï¼ŒæŒ‰éˆ•æœƒè‡ªå‹•åœç”¨ã€‚</li>
                </ul>
              </details>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="card bg-dark border-0 shadow mb-4">
          <div class="card-body">
            <h2 class="h6">æ‹ç…§çµæœ</h2>
            <canvas id="snapshot" class="mb-2" aria-label="ç›¸ç‰‡å¿«ç…§" hidden></canvas>
            <img id="snapshotImg" alt="å¿«ç…§é è¦½" class="img-fluid" hidden />
            <div class="hint">æŒ‰ã€Œæ‹ç…§ã€å¾Œå¯ä¸‹è¼‰ JPGã€‚å¯è‡ªè¡Œæ”¹ç‚º PNG æˆ– WebPã€‚</div>
          </div>
        </div>

        <div class="card bg-dark border-0 shadow">
          <div class="card-body">
            <h2 class="h6">å‚™ç”¨æ–¹æ¡ˆï¼ˆç„¡æ³•å–ç”¨ç›¸æ©Ÿæ™‚ï¼‰</h2>
            <input id="fallbackInput" type="file" accept="image/*" capture="environment" class="form-control mb-2" />
            <div class="hint">æŸäº›ç€è¦½å™¨å¯ç”¨ <span class="mono">capture="environment"</span> ç›´æ¥å–šèµ·å¾Œé¡é ­ã€‚</div>
          </div>
        </div>
      </div>
    </div>

    <footer class="mt-4 hint">
      <hr class="border-secondary">
      <p class="mb-0">Â© 2025 ç›¸æ©Ÿå–ç”¨ç¤ºç¯„ã€‚é€™æ˜¯å¯ç›´æ¥éƒ¨ç½²çš„å–®æª”é é¢ã€‚</p>
    </footer>
  </div>

  <script>
    // ----------------------
    // ç‹€æ…‹è®Šæ•¸
    // ----------------------
    let currentStream = null;
    let usingFacingMode = true; // ä»¥ facingMode æ¨¡å¼ï¼ˆuser/environmentï¼‰ç‚ºä¸»
    let isBack = true;          // true: å¾Œé¡é ­, false: å‰é¡é ­
    let hasTorch = false;       // æ˜¯å¦æ”¯æ´æ‰‹é›»ç­’
    let imageCapture = null;    // ç”¨æ–¼æ§åˆ¶æ‰‹é›»ç­’ï¼ˆè‹¥æ”¯æ´ï¼‰

    const els = {
      preview: document.getElementById('preview'),
      cameraSelect: document.getElementById('cameraSelect'),
      mirror: document.getElementById('mirror'),
      btnStart: document.getElementById('btnStart'),
      btnStop: document.getElementById('btnStop'),
      btnSwitch: document.getElementById('btnSwitch'),
      btnTorch: document.getElementById('btnTorch'),
      btnShot: document.getElementById('btnShot'),
      btnDownload: document.getElementById('btnDownload'),
      snapshot: document.getElementById('snapshot'),
      snapshotImg: document.getElementById('snapshotImg'),
      fallbackInput: document.getElementById('fallbackInput'),
    };

    // ----------------------
    // å·¥å…·å‡½å¼
    // ----------------------
    function setButtons(started) {
      els.btnStart.disabled = started;
      els.btnStop.disabled = !started;
      els.btnSwitch.disabled = !started;
      els.btnTorch.disabled = !(started && hasTorch);
      els.btnShot.disabled = !started;
    }

    function stopStream() {
      if (currentStream) {
        currentStream.getTracks().forEach(t => t.stop());
        currentStream = null;
      }
      imageCapture = null;
      hasTorch = false;
      setButtons(false);
    }

    function applyMirror() {
      const scale = els.mirror.checked ? '-1' : '1';
      els.preview.style.transform = `scaleX(${scale})`;
    }

    // å–å¾—ç›¸æ©Ÿæ¸…å–®ï¼ˆéœ€å…ˆå–å¾—ä¸€æ¬¡æˆæ¬Šï¼‰
    async function listCameras() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videos = devices.filter(d => d.kind === 'videoinput');

      // æ¸…ç©ºä¸¦å¡«å…¥é¸é …
      els.cameraSelect.innerHTML = '';
      videos.forEach((d, i) => {
        const opt = document.createElement('option');
        opt.value = d.deviceId;
        opt.textContent = d.label || `ç›¸æ©Ÿ ${i + 1}`;
        els.cameraSelect.appendChild(opt);
      });

      // è‹¥è£ç½®æ”¯æ´å¤šé¡é ­ï¼Œé¡¯ç¤ºé¸å–®ï¼›å¦å‰‡å¯ç•™ç©ºï¼Œä½†ä¿ç•™ facingMode åˆ‡æ›
      els.cameraSelect.parentElement.style.display = videos.length > 1 ? '' : '';
    }

    // å•Ÿå‹•ç›¸æ©Ÿï¼šå„ªå…ˆä»¥ facingMode æ§åˆ¶ï¼ˆæœ€é€šç”¨ï¼‰
    async function startCamera() {
      try {
        stopStream();

        const constraints = {
          audio: false,
          video: usingFacingMode ? {
            facingMode: isBack ? { ideal: 'environment' } : { ideal: 'user' },
            width: { ideal: 1920 },
            height: { ideal: 1080 },
          } : {
            deviceId: els.cameraSelect.value ? { exact: els.cameraSelect.value } : undefined,
            width: { ideal: 1920 },
            height: { ideal: 1080 },
          }
        };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        currentStream = stream;
        els.preview.srcObject = stream;
        await els.preview.play();

        // å˜—è©¦å»ºç«‹ ImageCapture ä»¥åµæ¸¬æ‰‹é›»ç­’
        const track = stream.getVideoTracks()[0];
        try {
          imageCapture = new ImageCapture(track);
        } catch (_) {
          imageCapture = null;
        }

        // æª¢æŸ¥ torch èƒ½åŠ›
        try {
          const capabilities = track.getCapabilities ? track.getCapabilities() : {};
          hasTorch = !!capabilities.torch;
        } catch (_) {
          hasTorch = false;
        }

        setButtons(true);
        applyMirror();

        // ç¬¬ä¸€æ¬¡å•Ÿå‹•å¾Œå†åˆ—å‡ºè¨­å‚™ï¼ˆå¯å–å¾— labelï¼‰
        await listCameras();
      } catch (err) {
        alert('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼š' + (err && err.message ? err.message : err));
        console.error(err);
      }
    }

    async function toggleTorch() {
      if (!currentStream) return;
      const track = currentStream.getVideoTracks()[0];
      if (!track) return;

      try {
        const caps = track.getCapabilities?.() || {};
        if (!caps.torch) return;

        const settings = track.getSettings?.() || {};
        const torchOn = !settings.torch;
        await track.applyConstraints({ advanced: [{ torch: torchOn }] });
      } catch (err) {
        console.warn('åˆ‡æ›æ‰‹é›»ç­’å¤±æ•—ï¼š', err);
      }
    }

    function takePhoto() {
      if (!currentStream) return;
      const track = currentStream.getVideoTracks()[0];
      const { width, height } = els.preview.getBoundingClientRect();

      const w = Math.floor(width);
      const h = Math.floor(height);

      const canvas = els.snapshot;
      canvas.width = w;
      canvas.height = h;

      const ctx = canvas.getContext('2d');

      // è™•ç†é¡åƒ
      if (els.mirror.checked) {
        ctx.translate(w, 0);
        ctx.scale(-1, 1);
      }

      ctx.drawImage(els.preview, 0, 0, w, h);

      // ç”¢å‡º JPEGï¼ˆå¯æ”¹ 'image/png' æˆ– 'image/webp'ï¼‰
      const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
      els.snapshotImg.src = dataUrl;
      els.snapshotImg.hidden = false;
      canvas.hidden = true; // è‹¥æƒ³é¡¯ç¤º Canvasï¼Œå¯æ”¹ç‚º false

      els.btnDownload.href = dataUrl;
      els.btnDownload.classList.remove('disabled');
    }

    // ----------------------
    // äº‹ä»¶ç¶å®š
    // ----------------------
    els.btnStart.addEventListener('click', () => startCamera());
    els.btnStop.addEventListener('click', () => stopStream());

    els.btnSwitch.addEventListener('click', async () => {
      // å…©ç¨®åˆ‡æ›ç­–ç•¥ï¼š
      // 1) ä½¿ç”¨ facingMode åœ¨ user/environment é–“åˆ‡æ›ï¼ˆé€šç”¨ï¼‰
      // 2) ä½¿ç”¨ä¸‹æ‹‰é¸å–®æŒ‡å®š deviceIdï¼ˆæ›´ç²¾æº–ï¼‰
      if (usingFacingMode) {
        isBack = !isBack;
        await startCamera();
      } else {
        const options = els.cameraSelect.options;
        if (options.length > 1) {
          const idx = els.cameraSelect.selectedIndex;
          els.cameraSelect.selectedIndex = (idx + 1) % options.length;
          await startCamera();
        }
      }
    });

    els.btnTorch.addEventListener('click', () => toggleTorch());
    els.btnShot.addEventListener('click', () => takePhoto());
    els.mirror.addEventListener('change', applyMirror);

    // åˆ‡æ›æ§åˆ¶æ¨¡å¼ï¼ˆä½¿ç”¨ deviceId æˆ– facingModeï¼‰
    els.cameraSelect.addEventListener('change', async () => {
      usingFacingMode = false; // ä½¿ç”¨é¸å–®æ™‚ï¼Œæ”¹ç”¨ deviceId æ¨¡å¼
      await startCamera();
    });

    // å‚™ç”¨ï¼šæª”æ¡ˆè¼¸å…¥
    els.fallbackInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        els.snapshotImg.src = reader.result;
        els.snapshotImg.hidden = false;
        els.btnDownload.href = reader.result;
        els.btnDownload.classList.remove('disabled');
      };
      reader.readAsDataURL(file);
    });

    // é è¨­ï¼šå¦‚å¯ç”¨å°±ç›´æ¥åˆ—å‡ºè¨­å‚™ï¼ˆéœ€å…ˆå–å¾—ä¸€æ¬¡æ¬Šé™æ‰æœƒæœ‰åç¨±ï¼‰
    if (navigator.mediaDevices?.enumerateDevices) {
      navigator.mediaDevices.enumerateDevices().then(() => {}).catch(() => {});
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
