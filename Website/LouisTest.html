<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>手機相機取用（Bootstrap 5）</title>

  <!-- Bootstrap 5 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" />

  <style>
    body { background: #0f172a; color: #e2e8f0; }
    .card { border-radius: 1rem; }
    video, canvas, img { width: 100%; border-radius: .75rem; background: #111827; }
    .device-select { max-width: 520px; }
    .hint { color: #94a3b8; font-size: .95rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .btn-wrap { gap: .5rem; flex-wrap: wrap; }
  </style>
</head>
<body>
  <div class="container py-4">
    <header class="mb-4">
      <h1 class="h3 mb-1">📷 手機相機取用 Demo</h1>
      <p class="hint mb-0">需在 <span class="mono">HTTPS</span> 或本機 <span class="mono">localhost</span> 上開啟。iOS Safari 請關閉「低耗電模式」。</p>
    </header>

    <div class="row g-4">
      <div class="col-12 col-lg-8">
        <div class="card bg-dark border-0 shadow">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <div class="device-select w-100 me-2">
                <label for="cameraSelect" class="form-label mb-1">選擇相機（如有多鏡頭）</label>
                <select id="cameraSelect" class="form-select form-select-sm"></select>
              </div>
              <div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="mirror" checked>
                  <label class="form-check-label" for="mirror">鏡像顯示</label>
                </div>
              </div>
            </div>

            <div class="ratio ratio-4x3 mb-3">
              <video id="preview" playsinline muted></video>
            </div>

            <div class="d-flex btn-wrap">
              <button id="btnStart" class="btn btn-success btn-sm">啟動相機</button>
              <button id="btnStop" class="btn btn-outline-light btn-sm" disabled>停止相機</button>
              <button id="btnSwitch" class="btn btn-primary btn-sm" disabled>切換前/後鏡頭</button>
              <button id="btnTorch" class="btn btn-outline-warning btn-sm" disabled>手電筒</button>
              <button id="btnShot" class="btn btn-info btn-sm" disabled>拍照</button>
              <a id="btnDownload" class="btn btn-outline-info btn-sm disabled" download="capture.jpg">下載照片</a>
            </div>

            <div class="mt-3 hint">
              <details>
                <summary class="mb-2">常見狀況與解法</summary>
                <ul class="mb-0">
                  <li>第一次使用需授權相機權限；若被拒，可至瀏覽器設定 → 網站設定 → 相機 → 允許。</li>
                  <li>iOS Safari 需 <span class="mono">playsinline</span> 與 <span class="mono">muted</span> 才能自動播放預覽。</li>
                  <li>某些裝置不支援手電筒或切換鏡頭，按鈕會自動停用。</li>
                </ul>
              </details>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="card bg-dark border-0 shadow mb-4">
          <div class="card-body">
            <h2 class="h6">拍照結果</h2>
            <canvas id="snapshot" class="mb-2" aria-label="相片快照" hidden></canvas>
            <img id="snapshotImg" alt="快照預覽" class="img-fluid" hidden />
            <div class="hint">按「拍照」後可下載 JPG。可自行改為 PNG 或 WebP。</div>
          </div>
        </div>

        <div class="card bg-dark border-0 shadow">
          <div class="card-body">
            <h2 class="h6">備用方案（無法取用相機時）</h2>
            <input id="fallbackInput" type="file" accept="image/*" capture="environment" class="form-control mb-2" />
            <div class="hint">某些瀏覽器可用 <span class="mono">capture="environment"</span> 直接喚起後鏡頭。</div>
          </div>
        </div>
      </div>
    </div>

    <footer class="mt-4 hint">
      <hr class="border-secondary">
      <p class="mb-0">© 2025 相機取用示範。這是可直接部署的單檔頁面。</p>
    </footer>
  </div>

  <script>
    // ----------------------
    // 狀態變數
    // ----------------------
    let currentStream = null;
    let usingFacingMode = true; // 以 facingMode 模式（user/environment）為主
    let isBack = true;          // true: 後鏡頭, false: 前鏡頭
    let hasTorch = false;       // 是否支援手電筒
    let imageCapture = null;    // 用於控制手電筒（若支援）

    const els = {
      preview: document.getElementById('preview'),
      cameraSelect: document.getElementById('cameraSelect'),
      mirror: document.getElementById('mirror'),
      btnStart: document.getElementById('btnStart'),
      btnStop: document.getElementById('btnStop'),
      btnSwitch: document.getElementById('btnSwitch'),
      btnTorch: document.getElementById('btnTorch'),
      btnShot: document.getElementById('btnShot'),
      btnDownload: document.getElementById('btnDownload'),
      snapshot: document.getElementById('snapshot'),
      snapshotImg: document.getElementById('snapshotImg'),
      fallbackInput: document.getElementById('fallbackInput'),
    };

    // ----------------------
    // 工具函式
    // ----------------------
    function setButtons(started) {
      els.btnStart.disabled = started;
      els.btnStop.disabled = !started;
      els.btnSwitch.disabled = !started;
      els.btnTorch.disabled = !(started && hasTorch);
      els.btnShot.disabled = !started;
    }

    function stopStream() {
      if (currentStream) {
        currentStream.getTracks().forEach(t => t.stop());
        currentStream = null;
      }
      imageCapture = null;
      hasTorch = false;
      setButtons(false);
    }

    function applyMirror() {
      const scale = els.mirror.checked ? '-1' : '1';
      els.preview.style.transform = `scaleX(${scale})`;
    }

    // 取得相機清單（需先取得一次授權）
    async function listCameras() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videos = devices.filter(d => d.kind === 'videoinput');

      // 清空並填入選項
      els.cameraSelect.innerHTML = '';
      videos.forEach((d, i) => {
        const opt = document.createElement('option');
        opt.value = d.deviceId;
        opt.textContent = d.label || `相機 ${i + 1}`;
        els.cameraSelect.appendChild(opt);
      });

      // 若裝置支援多鏡頭，顯示選單；否則可留空，但保留 facingMode 切換
      els.cameraSelect.parentElement.style.display = videos.length > 1 ? '' : '';
    }

    // 啟動相機：優先以 facingMode 控制（最通用）
    async function startCamera() {
      try {
        stopStream();

        const constraints = {
          audio: false,
          video: usingFacingMode ? {
            facingMode: isBack ? { ideal: 'environment' } : { ideal: 'user' },
            width: { ideal: 1920 },
            height: { ideal: 1080 },
          } : {
            deviceId: els.cameraSelect.value ? { exact: els.cameraSelect.value } : undefined,
            width: { ideal: 1920 },
            height: { ideal: 1080 },
          }
        };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        currentStream = stream;
        els.preview.srcObject = stream;
        await els.preview.play();

        // 嘗試建立 ImageCapture 以偵測手電筒
        const track = stream.getVideoTracks()[0];
        try {
          imageCapture = new ImageCapture(track);
        } catch (_) {
          imageCapture = null;
        }

        // 檢查 torch 能力
        try {
          const capabilities = track.getCapabilities ? track.getCapabilities() : {};
          hasTorch = !!capabilities.torch;
        } catch (_) {
          hasTorch = false;
        }

        setButtons(true);
        applyMirror();

        // 第一次啟動後再列出設備（可取得 label）
        await listCameras();
      } catch (err) {
        alert('無法啟動相機：' + (err && err.message ? err.message : err));
        console.error(err);
      }
    }

    async function toggleTorch() {
      if (!currentStream) return;
      const track = currentStream.getVideoTracks()[0];
      if (!track) return;

      try {
        const caps = track.getCapabilities?.() || {};
        if (!caps.torch) return;

        const settings = track.getSettings?.() || {};
        const torchOn = !settings.torch;
        await track.applyConstraints({ advanced: [{ torch: torchOn }] });
      } catch (err) {
        console.warn('切換手電筒失敗：', err);
      }
    }

    function takePhoto() {
      if (!currentStream) return;
      const track = currentStream.getVideoTracks()[0];
      const { width, height } = els.preview.getBoundingClientRect();

      const w = Math.floor(width);
      const h = Math.floor(height);

      const canvas = els.snapshot;
      canvas.width = w;
      canvas.height = h;

      const ctx = canvas.getContext('2d');

      // 處理鏡像
      if (els.mirror.checked) {
        ctx.translate(w, 0);
        ctx.scale(-1, 1);
      }

      ctx.drawImage(els.preview, 0, 0, w, h);

      // 產出 JPEG（可改 'image/png' 或 'image/webp'）
      const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
      els.snapshotImg.src = dataUrl;
      els.snapshotImg.hidden = false;
      canvas.hidden = true; // 若想顯示 Canvas，可改為 false

      els.btnDownload.href = dataUrl;
      els.btnDownload.classList.remove('disabled');
    }

    // ----------------------
    // 事件綁定
    // ----------------------
    els.btnStart.addEventListener('click', () => startCamera());
    els.btnStop.addEventListener('click', () => stopStream());

    els.btnSwitch.addEventListener('click', async () => {
      // 兩種切換策略：
      // 1) 使用 facingMode 在 user/environment 間切換（通用）
      // 2) 使用下拉選單指定 deviceId（更精準）
      if (usingFacingMode) {
        isBack = !isBack;
        await startCamera();
      } else {
        const options = els.cameraSelect.options;
        if (options.length > 1) {
          const idx = els.cameraSelect.selectedIndex;
          els.cameraSelect.selectedIndex = (idx + 1) % options.length;
          await startCamera();
        }
      }
    });

    els.btnTorch.addEventListener('click', () => toggleTorch());
    els.btnShot.addEventListener('click', () => takePhoto());
    els.mirror.addEventListener('change', applyMirror);

    // 切換控制模式（使用 deviceId 或 facingMode）
    els.cameraSelect.addEventListener('change', async () => {
      usingFacingMode = false; // 使用選單時，改用 deviceId 模式
      await startCamera();
    });

    // 備用：檔案輸入
    els.fallbackInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        els.snapshotImg.src = reader.result;
        els.snapshotImg.hidden = false;
        els.btnDownload.href = reader.result;
        els.btnDownload.classList.remove('disabled');
      };
      reader.readAsDataURL(file);
    });

    // 預設：如可用就直接列出設備（需先取得一次權限才會有名稱）
    if (navigator.mediaDevices?.enumerateDevices) {
      navigator.mediaDevices.enumerateDevices().then(() => {}).catch(() => {});
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
