<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QR 掃描 → 自動填入 → 送到電腦</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" />
<style>
  body{background:#0b1220;color:#e5e7eb}
  .card{border-radius:1rem}
  video,canvas{width:100%;border-radius:.75rem;background:#111827}
  .hint{color:#94a3b8}
  pre{white-space:pre-wrap;word-break:break-all}
  .kbd{padding:.1rem .35rem;border:1px solid #666;border-radius:.25rem;background:#111}
</style>
</head>
<body>
<div class="container py-4">
  <h1 class="h4 mb-3">📱 QR 掃描 → 自動填入 → 送到電腦</h1>
  <p class="hint">
    建議在 <b>同一來源</b>（例如 <span class="kbd">http://&lt;電腦IP&gt;:54321/ui</span>）開啟本頁。<br>
    若你從 GitHub Pages（HTTPS）開啟，請在下方填入 <b>HTTP 端點</b> 例如：<span class="kbd">http://192.168.0.67:54321/fill</span>。
  </p>

  <!-- 設定列 -->
  <div class="card bg-dark border-0 shadow mb-4">
    <div class="card-body row g-3 align-items-end">
      <div class="col-12 col-lg-6">
        <label class="form-label">送出端點（預設自動偵測同源 /fill）</label>
        <input id="endpoint" class="form-control form-control-sm" placeholder="/fill 或 http://192.168.x.x:54321/fill">
        <div class="form-text text-secondary">會記住在本機裝置（localStorage）。</div>
      </div>
      <div class="col-6 col-lg-2">
        <label class="form-label">鏡頭</label>
        <select id="mode" class="form-select form-select-sm">
          <option value="environment" selected>後鏡頭</option>
          <option value="user">前鏡頭</option>
        </select>
      </div>
      <div class="col-6 col-lg-2">
        <div class="form-check">
          <input id="autoSend" class="form-check-input" type="checkbox" checked>
          <label class="form-check-label" for="autoSend">掃到自動送出</label>
        </div>
        <div class="form-check">
          <input id="clearOnSend" class="form-check-input" type="checkbox">
          <label class="form-check-label" for="clearOnSend">送出後清空欄位</label>
        </div>
      </div>
      <div class="col-12 col-lg-2 d-grid gap-2">
        <button id="btnPing" class="btn btn-outline-info btn-sm">Ping 測試</button>
        <button id="btnSaveEP" class="btn btn-outline-secondary btn-sm">儲存端點</button>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- 左：相機 -->
    <div class="col-12 col-lg-7">
      <div class="card bg-dark border-0 shadow">
        <div class="card-body">
          <div class="d-flex gap-2 flex-wrap mb-3">
            <button id="btnStart" class="btn btn-success btn-sm">開始掃描</button>
            <button id="btnStop" class="btn btn-outline-light btn-sm" disabled>停止</button>
            <span class="hint">iOS 需在 HTTPS 或 localhost 開啟以允許相機。</span>
          </div>
          <div class="ratio ratio-4x3 mb-2">
            <video id="preview" playsinline muted></video>
          </div>
          <canvas id="work" class="d-none"></canvas>
          <div class="hint">若畫面未播放，請再按「開始掃描」，或檢查相機權限。</div>
        </div>
      </div>
    </div>

    <!-- 右：結果＋手動欄位＋送出 -->
    <div class="col-12 col-lg-5">
      <div class="card bg-dark border-0 shadow mb-4">
        <div class="card-body">
          <h2 class="h6">掃描結果</h2>
          <pre id="scanText" class="p-2 bg-black rounded" style="min-height:5.5rem">（尚未掃到內容）</pre>
          <div class="d-flex gap-2 flex-wrap">
            <button id="btnCopy" class="btn btn-primary btn-sm" disabled>複製結果</button>
            <a id="btnOpen" class="btn btn-outline-info btn-sm disabled" target="_blank" rel="noopener">在新分頁開啟（若為網址）</a>
            <button id="btnParse" class="btn btn-outline-warning btn-sm">重解析 → 填入</button>
          </div>
        </div>
      </div>

      <div class="card bg-dark border-0 shadow">
        <div class="card-body">
          <h2 class="h6">要送到電腦的五個欄位</h2>
          <div class="row g-2">
            <div class="col-12"><input id="tb1" class="form-control form-control-sm" placeholder="tb1：例 單號"></div>
            <div class="col-12"><input id="tb2" class="form-control form-control-sm" placeholder="tb2：例 料號"></div>
            <div class="col-12"><input id="tb3" class="form-control form-control-sm" placeholder="tb3：例 批號"></div>
            <div class="col-12"><input id="tb4" class="form-control form-control-sm" placeholder="tb4：例 數量"></div>
            <div class="col-12"><input id="tb5" class="form-control form-control-sm" placeholder="tb5：例 備註"></div>
          </div>
          <div class="d-flex gap-2 flex-wrap mt-3">
            <button id="btnSend" class="btn btn-success btn-sm">送出到電腦</button>
            <input id="token" class="form-control form-control-sm" style="max-width:12rem" placeholder="可選 token">
            <input id="sep" class="form-control form-control-sm" style="max-width:8rem" placeholder="分隔符(可空)">
            <span class="hint">若 QR 是單行字串，可設定分隔符（如 <b>|</b> 或 <b>,</b>）。</span>
          </div>
          <hr class="border-secondary">
          <div>
            <label class="form-label">備用：從相簿選擇圖片</label>
            <input id="fileInput" type="file" accept="image/*" capture="environment" class="form-control" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="mt-4 hint">
    <hr class="border-secondary">
    <small>© 2025 QR→填入→送出。支援 querystring / CSV / pipe / 空白 / JSON 自動解析。</small>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
let stream=null, scanning=false;
const $=id=>document.getElementById(id);
const els={ preview:$('preview'), work:$('work'),
  btnStart:$('btnStart'), btnStop:$('btnStop'),
  scanText:$('scanText'), btnCopy:$('btnCopy'), btnOpen:$('btnOpen'),
  btnParse:$('btnParse'), fileInput:$('fileInput'),
  tb1:$('tb1'), tb2:$('tb2'), tb3:$('tb3'), tb4:$('tb4'), tb5:$('tb5'),
  btnSend:$('btnSend'), token:$('token'), sep:$('sep'),
  endpoint:$('endpoint'), btnPing:$('btnPing'), btnSaveEP:$('btnSaveEP'),
  mode:$('mode'), autoSend:$('autoSend'), clearOnSend:$('clearOnSend')
};

// --- 端點偵測/保存 ---
(function initEndpoint(){
  const saved = localStorage.getItem('qr_endpoint');
  // 若同源（例如 http://192.168.0.67:54321/ui），預設用 /fill
  const defaultEP = '/fill';
  els.endpoint.value = saved || defaultEP;
})();
els.btnSaveEP.onclick=()=>{ localStorage.setItem('qr_endpoint', els.endpoint.value.trim()); alert('端點已儲存'); };

// --- 相機控制 ---
function setUI(r){ els.btnStart.disabled=r; els.btnStop.disabled=!r; }
function stop(){ scanning=false; if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } setUI(false); }
async function start(){
  try{
    stop();
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ideal: els.mode.value||'environment'}, width:{ideal:1280}, height:{ideal:720} }, audio:false
    });
    els.preview.srcObject=stream; await els.preview.play();
    scanning=true; setUI(true); requestAnimationFrame(tick);
  }catch(err){ alert('無法啟動相機：'+(err?.message||err)); stop(); }
}
els.btnStart.onclick=start; els.btnStop.onclick=stop; els.mode.onchange=()=>{ if(scanning) start(); };

// --- 掃描循環 ---
function tick(){
  if(!scanning) return;
  const v=els.preview;
  if(v.readyState===v.HAVE_ENOUGH_DATA){
    const c=els.work, w=v.videoWidth, h=v.videoHeight;
    c.width=w; c.height=h; const ctx=c.getContext('2d');
    ctx.drawImage(v,0,0,w,h);
    const img = ctx.getImageData(0,0,w,h);
    const code = jsQR(img.data,w,h,{inversionAttempts:'dontInvert'});
    if(code && code.data){
      showScan(code.data); stop();
      tryFill(code.data);  // 自動解析 → 填入
      if(els.autoSend.checked) send();
      return;
    }
  }
  requestAnimationFrame(tick);
}

// --- 顯示/解析 ---
function showScan(text){
  els.scanText.textContent = text||'（沒有內容）';
  els.btnCopy.disabled = !text;
  if(/^https?:\/\//i.test(text)){ els.btnOpen.classList.remove('disabled'); els.btnOpen.href=text; }
  else { els.btnOpen.classList.add('disabled'); els.btnOpen.removeAttribute('href'); }
}
els.btnCopy.onclick=async()=>{ try{ await navigator.clipboard.writeText(els.scanText.textContent.trim()); }catch(_){} };

// 解析規則：querystring(tb1~tb5) > JSON(鍵/陣列) > 分隔符 > 空白切5 > CSV
function tryFill(raw){
  const text = (raw||'').trim();
  if(!text){ return; }

  // 1) querystring（URL?tb1=...&tb2=...）
  try{
    const u = new URL(text);
    const qs = u.searchParams;
    const v1=qs.get('tb1'), v2=qs.get('tb2'), v3=qs.get('tb3'), v4=qs.get('tb4'), v5=qs.get('tb5');
    if(v1||v2||v3||v4||v5){
      setTB(v1,v2,v3,v4,v5); return;
    }
  }catch(_){/* 非 URL */}
  if(text.includes('=')){ // 純 querystring 形式 tb1=...&tb2=...
    const qs = new URLSearchParams(text);
    const v1=qs.get('tb1'), v2=qs.get('tb2'), v3=qs.get('tb3'), v4=qs.get('tb4'), v5=qs.get('tb5');
    if(v1||v2||v3||v4||v5){ setTB(v1,v2,v3,v4,v5); return; }
  }

  // 2) JSON
  if(text.startsWith('{') || text.startsWith('[')){
    try{
      const obj = JSON.parse(text);
      if(Array.isArray(obj) && obj.length===5){ setTB(obj[0],obj[1],obj[2],obj[3],obj[4]); return; }
      if(obj && typeof obj==='object'){
        const v1=obj.tb1??obj.TB1??obj.Tb1, v2=obj.tb2??obj.TB2??obj.Tb2, v3=obj.tb3??obj.TB3??obj.Tb3,
              v4=obj.tb4??obj.TB4??obj.Tb4, v5=obj.tb5??obj.TB5??obj.Tb5;
        if(v1||v2||v3||v4||v5){ setTB(v1,v2,v3,v4,v5); return; }
      }
    }catch(_){}
  }

  // 3) 指定分隔符
  const sep = els.sep.value;
  if(sep){
    const parts = text.split(sep);
    if(parts.length>=5){ setTB(parts[0],parts[1],parts[2],parts[3],parts[4]); return; }
  }

  // 4) 常見分隔符（|、逗號、空白）
  for(const s of ['|',',',' ']){
    const arr = text.split(s).filter(x=>x.length>0);
    if(arr.length>=5){ setTB(arr[0],arr[1],arr[2],arr[3],arr[4]); return; }
  }

  // 5) 落空：只塞 tb1
  setTB(text,'','','','');
}
function setTB(a,b,c,d,e){
  els.tb1.value=a??''; els.tb2.value=b??''; els.tb3.value=c??''; els.tb4.value=d??''; els.tb5.value=e??'';
}
els.btnParse.onclick=()=>tryFill(els.scanText.textContent.trim());

// 圖片備援
els.fileInput.addEventListener('change', e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const imgEl = new Image();
  imgEl.onload=()=>{
    const c=els.work; c.width=imgEl.naturalWidth; c.height=imgEl.naturalHeight;
    const ctx=c.getContext('2d'); ctx.drawImage(imgEl,0,0);
    const img=ctx.getImageData(0,0,c.width,c.height);
    const code=jsQR(img.data,c.width,c.height,{inversionAttempts:'dontInvert'});
    if(code && code.data){ showScan(code.data); tryFill(code.data); if(els.autoSend.checked) send(); }
    else { showScan('（圖片未偵測到 QR）'); }
  };
  imgEl.onerror=()=>showScan('（圖片載入失敗）');
  imgEl.src=URL.createObjectURL(f);
});

// --- 送出到電腦 ---
async function send(){
  const base = (els.endpoint.value||'').trim() || '/fill';
  const p = new URLSearchParams({
    tb1: els.tb1.value||'',
    tb2: els.tb2.value||'',
    tb3: els.tb3.value||'',
    tb4: els.tb4.value||'',
    tb5: els.tb5.value||''
  });
  const token = (els.token.value||'').trim();
  if(token) p.append('token', token);

  try{
    const r = await fetch(base + '?' + p.toString(), { method:'GET' });
    const t = await r.text();
    alert('回應：' + t);
    if(els.clearOnSend.checked){ setTB('','','','',''); }
  }catch(e){
    alert('送出失敗：' + (e?.message||e));
  }
}
els.btnSend.onclick=send;

// --- Ping 測試（會把 /fill 換成 /ping）---
els.btnPing.onclick=async()=>{
  let ep = (els.endpoint.value||'').trim() || '/fill';
  ep = ep.replace(/\/fill\/?$/i,'/ping');
  try{
    const r = await fetch(ep, { method:'GET' });
    alert('Ping 回應：' + await r.text());
  }catch(e){ alert('Ping 失敗：' + (e?.message||e)); }
};
</script>
</body>
</html>
